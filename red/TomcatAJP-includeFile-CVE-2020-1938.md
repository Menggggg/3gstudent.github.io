# Apache-Tomcat-Ajp文件包含漏洞(CVE-2020-1938)

> 2020.2

## #漏洞描述

tomcat默认的conf/server.xml中配置了2个Connector，一个为8080的对外提供的HTTP协议端口，另外一个就是默认的`8009 AJP`协议端口，两个端口默认均监听在外网ip

Apache Tomcat服务器存在文件包含漏洞，攻击者可利用该漏洞读取或包含 Tomcat 上所有 `webapp` 目录下的任意文件，如：webapp 配置文件或源代码等，由于Tomcat默认开启的AJP服务（8009端口）存在一处文件包含缺陷，攻击者可构造恶意的请求包进行文件包含操作，进而读取受影响Tomcat服务器上的Web目录文件



## #影响范围

Apache Tomcat 6

Apache Tomcat 7 < 7.0.100

Apache Tomcat 8 < 8.5.51

Apache Tomcat 9 < 9.0.31

## #POC

https://github.com/nibiwodong/CNVD-2020-10487-Tomcat-ajp-POC

python poc.py -p 8009 -f "/WEB-INF/web.xml" 127.0.0.1

![tomcat](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjx3k3fmd0j318x0u0e81.jpg)

## #漏洞修复

1. 升级版本

2. （1）编辑 <CATALINA_BASE>/conf/server.xml，找到如下行（<CATALINA_BASE> 为 Tomcat 的工作目录）：

   `<Connector port="8009"protocol="AJP/1.3" redirectPort="8443" />`

   ![image-20201021174930639](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjx3o35kiuj31c00siqkb.jpg)

   注释掉或者删掉此行

   ```python
   <!--<Connectorport="8009" protocol="AJP/1.3"redirectPort="8443" />-->
   ```

   （3）保存后需重新启动Tomcat，规则方可生效。

3. 使用Tomcat 7和Tomcat 9的用户可为AJP Connector配置secret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）:

   ```python
   <Connector port="8009"protocol="AJP/1.3" redirectPort="8443"address="YOUR_TOMCAT_IP_ADDRESS" secret="YOUR_TOMCAT_AJP_SECRET"/>
   ```

   使用Tomcat 8的用户可为AJP Connector配置requiredSecret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：

   ```python
   <Connector port="8009"protocol="AJP/1.3" redirectPort="8443"address="YOUR_TOMCAT_IP_ADDRESS"requiredSecret="YOUR_TOMCAT_AJP_SECRET" />
   ```

